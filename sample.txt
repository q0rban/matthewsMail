<#
.DESCRIPTION
   This script will find the day of the year, extract that line from a file, parse the line
   into an e-mail address, first name and last name and then send an e-mail to that person.  The 
   script expects the input file to be comma delimited with just the three fields of e-mail  
   address, first name and last name.  It will also send an e-mail to the sender telling who to 
   be praying for.   

.NOTES
   File Name      : email_date.ps1
   Author         : Dave Sansbury
   Prerequisite   : PowerShell V2 over Vista and above

   The input file name and location should be set as well as the from e-mail address, its
   password, the subject, the SMTP server address, port, if SSL must be used and the
   authentication credentials.
#>

# Set up the variables
$File                   = "C:\Work\members_export.csv"
$Email_Date_File        = "C:\Work\email_date.txt"
$LogFile                = "C:\Work\email_date.log"
$From                   = "matthewsmaritimemissions@gmail.com"
$Password               = "xxxxxxxxxxxxx"
$Subject                = "Pray for Tim & Gina Matthews"
$SMTPServer             = "smtp.gmail.com"
$SMTPClient             = New-Object Net.Mail.SmtpClient($SmtpServer, 587)
$SMTPClient.EnableSsl   = $true
$SMTPClient.Credentials = New-Object System.Net.NetworkCredential($From, $Password);

# Get todays date
$date = Get-Date

# Set the day of the year variable to select the proper line
$Day = $date.dayofyear

# If the day is greater than 365 (leap year) then exit.
if($Day -gt 365)
   {Exit}

# Format the date as an ordered number to be filed
$o_date = $date.ToString("yyyyMMdd")

# Check to see if the date file exists
if(Test-Path $Email_Date_File)
   {
# The file exists so read the date and exit if it is today's date 
      $last_date = (Get-Content $Email_Date_File)
      if($o_date -eq $last_date)
         {Exit}
   }

# Extract the line from the input file for today's day of the year (less 1 because starts at 0)
$person = (Get-Content $File)[$Day-1]

# Parse the line into the first name and e-mail address
$name = $person.split(",")

# Set the to e-mail address variable
$To = $name[0]

# Set the first name variable
$First = $name[1]

# Set the last name variable
$Last = $name[2]

# Set the body variable
$Body = "Good Morning $First,

We are so thankful that you have committed to pray for us! Pray for God to open hearts of the people of Papua New Guinea, that they would see a need for Him in their lives and come to know Jesus as Savior. Pray our life verse with us: 'But seek first the kingdom and his righteousness, and all these things will be given to you as well.' Matthew 6:33

Please let us know how we can pray for you.

Much love & blessings,
Tim & Gina"

# Set the body of the note to us
$Our_Body = "Today we need to be praying for $First $Last - email: $To."

# Log what you are doing
add-content -path $logFile "Day $Day send an email to $First at $To `r"

# The line below is for testing - erase it or comment it out.
# $To = "sansbury@cfl.rr.com"

# Send the e-mail
$SMTPClient.Send($From, $To, $Subject, $Body)

# Send us an e-mail too
$SMTPClient.Send($From, $From, "Prayer Tomorrow", $Our_Body)

# Write today's ordered date to the email date file
$o_date | Out-File $Email_Date_File